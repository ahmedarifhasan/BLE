<!DOCTYPE html>
<html lang="en">

<head>
    <style>
        #terminal div {
            color: gray;
        }

        #terminal div.out {
            color: red;
        }

        #terminal div.in {
            color: blue;
        }
    </style>





    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> BLE SCANNER </title>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"
        integrity="sha384-LtrjvnR4Twt/qOuYxE721u19sVFLVSA4hf/rRt6PrZTmiPltdZcI7q7PXQBYTKyf" crossorigin="anonymous">
    </script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
</head>

<body>



    <button id="connect" type="button">Connect</button>

    <button id="disconnect" type="button">Disconnect</button>

    <div id="terminal">
        <div>Device connection...</div>
        <div class="out">Outcoming message</div>
        <div class="in">Incoming message</div>
    </div>

    <form id="send-form">
        <input id="input" type="text">
        <button type="submit">Send</button>
    </form>


    <div class="container" style="margin-top: 10%;">
        <div class="col">
            <div class="row">
                <h1 style="margin-left: 230px;"> Click to Connect to the BLE device</h1>
                <button class="btn btn-block btn-dark btn-lg" id="connct">
                    Connect
                </button>
            </div>
            <hr>
            <br><br>

            <div class="row">

                <form action="/home.html" method="post">
                    <h1>Input 1</h1>
                    <input type="text" value="1" name="input">
                    <button type="submit" class="btn btn-info btn-lg">Submit</button>
                </form>

                <form action="/home.html" method="post" style="margin-left: 470px;">
                    <h1>Input 2</h1>
                    <input type="text" value="2" name="input">
                    <button type="submit" class="btn btn-danger btn-lg">Submit</button>
                </form>
            </div>



</body>




<script defer>
    let id = (val) => {
        return document.getElementById(val);
    }

    let connectButton = document.getElementById('connect');
    let disconnectButton = document.getElementById('disconnect');
    let terminalContainer = document.getElementById('terminal');
    let sendForm = document.getElementById('send-form');
    let inputField = document.getElementById('input');

    connectButton.addEventListener('click', () => {
        connect();
    })
    let deviceCache = null;

    function connect() {
        return (deviceCache ? Promise.resolve(deviceCache) :
            requestBluetoothDevice()).
        then(device => connectDeviceAndCacheCharacteristic(device)).
        then(characteristic => startNotifications(characteristic)).
        catch(error => log(error));
    }

    function requestBluetoothDevice() {
        log('Requesting bluetooth device...');

        return navigator.bluetooth.requestDevice({
            filters: [{
                services: [0xFFE0]
            }],
        }).
        then(device => {
            log('"' + device.name + '" bluetooth device selected');
            deviceCache = device;

            return deviceCache;
        });
    }

    // Characteristic object cache
    let characteristicCache = null;

    // Connect to the device specified, get service and characteristic
    function connectDeviceAndCacheCharacteristic(device) {
        if (device.gatt.connected && characteristicCache) {
            return Promise.resolve(characteristicCache);
        }

        log('Connecting to GATT server...');

        return device.gatt.connect().
        then(server => {
            log('GATT server connected, getting service...');

            return server.getPrimaryService(0xFFE0);
        }).
        then(service => {
            log('Service found, getting characteristic...');

            return service.getCharacteristic(0xFFE1);
        }).
        then(characteristic => {
            log('Characteristic found');
            characteristicCache = characteristic;

            return characteristicCache;
        });
    }

    // Enable the characteristic changes notification
    function startNotifications(characteristic) {
        log('Starting notifications...');

        return characteristic.startNotifications().
        then(() => {
            log('Notifications started');
        });
    }


    // Output to terminal
    function log(data, type = '') {
        terminalContainer.insertAdjacentHTML('beforeend',
            '<div' + (type ? ' class="' + type + '"' : '') + '>' + data + '</div>');
    }
</script>



</html>
